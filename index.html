<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Diagnostic Reporter (Restored Functionality)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .diagnosis-card {
            box-shadow: 0 0 40px rgba(79, 70, 229, 0.1); /* Subtle Indigo shadow */
        }
        .main-container {
            border: 1px solid #e5e7eb;
        }
        .header-bg {
            background-image: linear-gradient(135deg, #4f46e5 0%, #a5b4fc 100%);
            color: white;
        }
        .processing {
            cursor: not-allowed;
            background-color: #9ca3af;
            transform: scale(1);
        }
        .report-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Custom scrollbar for report area */
        .report-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .report-scroll::-webkit-scrollbar-thumb {
            background-color: #c7d2fe;
            border-radius: 10px;
        }
    </style>
    <script>
        // Set the API Key (leaving it empty for the sandbox environment)
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Utility function for exponential backoff retry logic
        async function fetchWithRetry(url, options, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { // Not a Rate Limit error
                        return response;
                    }
                    // If 429 (Too Many Requests), log and retry
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000 + Math.random() * 1000));
                } catch (error) {
                    console.error("Fetch attempt failed:", error);
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000 + Math.random() * 1000));
                }
            }
            throw new Error('API request failed after multiple retries due to rate limiting.');
        }

        /**
         * Renders the analysis report from Markdown text.
         * @param {string} text - The Markdown text response from the model.
         * @param {Array} sources - The list of grounding sources.
         */
        function renderAnalysisReport(text, sources) {
            const resultsDiv = document.getElementById('results');
            // Use marked.parse for Markdown to HTML conversion
            const htmlText = marked.parse(text);

            let sourcesHtml = '';
            if (sources.length > 0) {
                sourcesHtml = `
                    <div class="mt-8 pt-4 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Sources Consulted:</h3>
                        <ul class="space-y-1 text-sm text-gray-600 list-disc list-inside ml-4">
                            ${sources.map(s => `
                                <li><a href="${s.uri}" target="_blank" class="text-indigo-600 hover:text-indigo-800 transition-colors duration-200">${s.title}</a></li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            resultsDiv.innerHTML = `
                <div class="report-content prose max-w-none p-6 md:p-8">
                    <h2 class="text-3xl font-bold text-indigo-700 border-b pb-3 mb-4">Diagnostic Report</h2>
                    ${htmlText}
                    ${sourcesHtml}
                    <p class="mt-6 text-sm italic text-red-600 font-medium border-t pt-4">Disclaimer: This report is generated by an AI model for analytical purposes only. It is NOT a substitute for professional judgment.</p>
                </div>
            `;
        }

        async function analyzeSymptoms() {
            const unifiedInput = document.getElementById('unifiedInput');
            const diagnoseButton = document.getElementById('diagnoseButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultsDiv = document.getElementById('results');
            const inputText = unifiedInput.value.trim();

            if (!inputText) {
                resultsDiv.innerHTML = '<p class="text-red-600 text-center p-4 bg-red-50 rounded-lg">Please enter data into the unified input box to begin the analysis.</p>';
                return;
            }

            // Get settings for future use (currently text output ignores these, but good practice to fetch them)
            const analysisDepth = document.getElementById('analysisDepth').value;
            const contextWeight = document.getElementById('contextWeight').value;

            const userQuery = `
                UNIFIED INPUT DATA:
                ---
                ${inputText}
                ---
            `;

            // Disable button and show loading
            diagnoseButton.disabled = true;
            diagnoseButton.classList.add('processing');
            diagnoseButton.textContent = 'Analyzing Data...';
            loadingIndicator.classList.remove('hidden');
            resultsDiv.innerHTML = '';

            let response;
            let responseText = '';
            
            try {
                // System prompt is configured for a robust Markdown text output
                const systemPrompt = `You are a highly analytical, conservative, and safety-focused diagnostic assistant. Based on the 'UNIFIED INPUT DATA' provided, you must generate a single, comprehensive report using Markdown formatting.

                The analysis must be rigorous, separating the data and performing a two-stage analysis (Symptomatic first, then Contextual integration). Use a high analysis depth (${analysisDepth}) and consider contextual data with moderate weight (${contextWeight}/10).

                Your report MUST follow this structure precisely, using Markdown headings and lists:

                # Comprehensive Diagnostic Analysis
                
                ## 1. Data Separation & Categorization
                
                ### A. Symptomatic/Objective Data (Measurements, Labs, Events)
                [Detailed summary of core issues, measurements, lab results, error codes, and explicit physical observations extracted from the input.]
                
                ### B. Environmental/Contextual Data (History, Lifestyle, Environment)
                [Detailed summary of lifestyle, patient history, usage patterns, environmental factors, and context extracted from the input.]

                ## 2. Two-Stage Analysis Summary
                [A paragraph explaining the analytical process: Initial hypotheses from Symptomatic Data, followed by critical adjustment using Contextual Data.]
                
                ## 3. Confidence Assessment
                - **AI Confidence Score:** [Your self-assessed confidence level (0% to 100%). You must explicitly state this score.]
                - **Confidence Rationale:** [A brief explanation of why the confidence is high (due to confirmatory data) or low (due to vague/missing data).]
                
                ## 4. Ranked Differential Diagnoses
                [A numbered list of diagnoses, ranked from most to least likely.]
                
                1. **[Diagnosis Name 1]** (Likelihood: [High/Medium/Low]): [Specific rationale based on the integrated data.]
                2. **[Diagnosis Name 2]** (Likelihood: [Medium/Low]): [Specific rationale based on the integrated data.]
                3. **[Diagnosis Name 3]** (Likelihood: [Low]): [Specific rationale based on the integrated data.]
                
                ## 5. Plan & Recommendations
                [An action-oriented, bulleted list of next steps.]

                ## 6. Essential Data Needed for Confirmation
                [A bulleted list of 3-5 concrete pieces of missing information required to achieve 90%+ confidence. If confidence is already high, state 'None, the provided data is sufficient for a confident assessment.']`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    }
                };

                response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    responseText = candidate.content.parts[0].text.trim();
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                         sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title }))
                            .filter(source => source.uri && source.title)
                            .slice(0, 5);
                    }
                    
                    // Render the full analysis report (Markdown text)
                    renderAnalysisReport(responseText, sources);

                } else {
                    resultsDiv.innerHTML = '<p class="text-red-600 text-center p-4 bg-red-50 rounded-lg">The AI failed to generate a diagnosis. Please try again with a more detailed description or check the console for API errors.</p>';
                }

            } catch (error) {
                console.error('API Error:', error);
                resultsDiv.innerHTML = `<p class="text-red-600 text-center p-4 bg-red-50 rounded-lg">An error occurred while communicating with the AI: ${error.message}</p>`;
            } finally {
                // Re-enable button and hide loading
                diagnoseButton.disabled = false;
                diagnoseButton.classList.remove('processing');
                diagnoseButton.textContent = 'Generate Detailed Report';
                loadingIndicator.classList.add('hidden');
            }
        }

        // Initialize marked.js for Markdown to HTML conversion
        const markedScript = document.createElement('script');
        markedScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.17/marked.min.js';
        document.head.appendChild(markedScript);
    </script>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-5xl mx-auto">
        
        <!-- Header -->
        <header class="header-bg p-6 rounded-t-xl mb-8 diagnosis-card">
            <h1 class="text-4xl font-extrabold text-center mb-1">
                AI Diagnostic Intelligence
            </h1>
            <p class="text-lg text-center text-indigo-200">System & Medical Analysis Tool</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Overview & Settings -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Product Overview Card -->
                <div class="bg-white p-6 rounded-xl diagnosis-card">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">Product Overview</h2>
                    <p class="text-gray-600 text-sm leading-relaxed">
                        This tool performs a highly structured, two-stage analysis on any provided data (medical charts, IT logs, engineering issues). It intelligently separates **Symptomatic/Objective** data from **Environmental/Contextual** data. It then ranks potential diagnoses, provides a confidence score, and suggests necessary next steps or missing data points.
                    </p>
                    <div class="mt-4 text-xs text-indigo-600 font-semibold flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        Focuses on safety and data sufficiency.
                    </div>
                </div>

                <!-- Settings Card (Sliders are currently decorative but represent influence on the analysis prompt) -->
                <div class="bg-white p-6 rounded-xl diagnosis-card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Analysis Settings</h2>
                    
                    <div class="mb-5">
                        <label for="analysisDepth" class="block text-sm font-medium text-gray-700 mb-1">Analysis Depth (Rigor)</label>
                        <input type="range" id="analysisDepth" min="1" max="10" value="8" class="w-full h-2 bg-indigo-100 rounded-lg appearance-none cursor-pointer range-lg transition-colors duration-200 hover:bg-indigo-200" disabled>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Shallow (1)</span>
                            <span>Deep (10)</span>
                        </div>
                    </div>

                    <div>
                        <label for="contextWeight" class="block text-sm font-medium text-gray-700 mb-1">Contextual Data Weight</label>
                        <input type="range" id="contextWeight" min="1" max="10" value="6" class="w-full h-2 bg-indigo-100 rounded-lg appearance-none cursor-pointer range-lg transition-colors duration-200 hover:bg-indigo-200" disabled>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>Low (1)</span>
                            <span>High (10)</span>
                        </div>
                    </div>

                    <p class="mt-4 text-xs italic text-gray-500">Settings are currently hardcoded in the AI prompt for stable output but show intended control.</p>
                </div>
            </div>

            <!-- Right Column: Input & Output -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Input Area -->
                <div class="bg-white p-6 rounded-xl diagnosis-card">
                    <label for="unifiedInput" class="block text-xl font-semibold text-gray-700 mb-3">2. Unified Input Area</label>
                    <textarea id="unifiedInput" rows="10" 
                            placeholder="Enter the complete dataset: system logs, full medical chart (like SOAP), or detailed observations. The AI will separate symptoms from context internally."
                            class="w-full p-4 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out resize-none text-gray-800 focus:shadow-indigo-300 focus:shadow-md"></textarea>
                    
                    <div class="mt-6 flex flex-col items-center">
                        <button id="diagnoseButton" onclick="analyzeSymptoms()"
                                class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-300 ease-in-out transform hover:scale-[1.03] active:scale-[0.98]">
                            Generate Detailed Report
                        </button>
                        <div id="loadingIndicator" class="hidden mt-4 flex items-center justify-center space-x-2 text-indigo-600 font-medium">
                            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Processing & Fact-Checking Diagnosis...</span>
                        </div>
                    </div>
                </div>

                <!-- Results Display Area -->
                <div id="results" class="mt-10 min-h-[300px]">
                    <div class="text-center text-gray-500 italic p-6 border-2 border-dashed border-indigo-200 rounded-xl bg-white">
                        <svg class="mx-auto h-12 w-12 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M13 12h.01"></path></svg>
                        <p class="mt-2 text-lg font-medium">Report Ready</p>
                        <p class="text-sm">Your comprehensive analysis will appear here after processing.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
